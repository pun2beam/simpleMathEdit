<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="./favicon.ico" sizes="any">
  <title>MathJax Live Preview</title>

  <!-- MathJax v3 -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
      },
    };
  </script>
  <script defer src="./es5/tex-mml-chtml.js"></script>
  <script src="./marked/marked.min.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, sans-serif; }
    .wrap { display: flex; height: 100vh; }
    .pane { padding: 12px; box-sizing: border-box; overflow: hidden; min-width: 0; flex: 1 1 0; }
    textarea { width: 99%; height: 99%; resize: none; font: 14px/1.4 ui-monospace, SFMono-Regular, Menlo, monospace; }
    .preview { border-left: 1px solid #ddd; overflow: auto; }
    #out { min-height: 100%; padding-bottom: 24px; }
    #caret-marker {
      display: inline-block;
      min-width: 6px;
      padding: 0 2px;
      margin: 0 1px;
      color: #b00020;
      background: rgba(255, 214, 102, 0.7);
      border-radius: 2px;
      font-weight: 700;
    }
    .hint { color: #666; font-size: 12px; margin-bottom: 8px; }
    .resizer {
      width: 6px;
      background: #f0f0f0;
      border-left: 1px solid #ddd;
      border-right: 1px solid #ddd;
      cursor: col-resize;
      flex: 0 0 6px;
    }
    .resizer:hover,
    .resizer.dragging {
      background: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="pane" id="left-pane">
      <textarea id="src">
インライン: $E=mc^2$

別行表示:
$$
\frac{\mathrm{d}y}{\mathrm{d}x}=g(y)h(x)
$$
      </textarea>
    </div>

    <div class="resizer" id="resizer" role="separator" aria-label="Resize panes" aria-orientation="vertical"></div>

    <div class="pane preview" id="right-pane">
      <div id="out"></div>
    </div>
  </div>

  <script>
    const src = document.getElementById('src');
    const out = document.getElementById('out');
    const resizer = document.getElementById('resizer');
    const leftPane = document.getElementById('left-pane');
    const rightPane = document.getElementById('right-pane');
    let timer = null;
    let dragging = false;

    marked.setOptions({ mangle: false, headerIds: false });

    const caretToken = '│';
    const caretHtml = '<span id="caret-marker" aria-hidden="true" data-mjx-skip="true">▌</span>';

    function buildSourceWithCaret() {
      const caretIndex = src.selectionStart ?? 0;
      return `${src.value.slice(0, caretIndex)}${caretToken}${src.value.slice(caretIndex)}`;
    }

    function syncScrollFromSource() {
      const outMax = out.scrollHeight - rightPane.clientHeight;
      if (outMax <= 0) {
        rightPane.scrollTop = 0;
        return;
      }
      const caretIndex = src.selectionStart ?? 0;
      const beforeCaret = src.value.slice(0, caretIndex);
      const caretLine = beforeCaret.split('\n').length;
      const totalLines = Math.max(src.value.split('\n').length, 1);
      const ratio = Math.min(Math.max((caretLine - 1) / Math.max(totalLines - 1, 1), 0), 1);
      const targetScrollTop = ratio * outMax;
      rightPane.scrollTop = targetScrollTop;
    }

    function normalizeDisplayMath(source) {
      const lines = source.split('\n');
      const normalized = [];
      let inDisplay = false;

      for (let line of lines) {
        if (line.trim() === '$$') {
          inDisplay = !inDisplay;
          normalized.push('$$');
          continue;
        }

        if (inDisplay && line.trim() === '') {
          continue;
        }

        if (inDisplay) {
          line = line.replace(/\\/g, '\\\\');
        }

        normalized.push(line);
      }

      return normalized.join('\n');
    }

    async function render() {
      const sourceWithCaret = normalizeDisplayMath(buildSourceWithCaret());
      // const html = marked.parse(sourceWithCaret);
      // out.innerHTML = html.replace(caretToken, caretHtml);
      out.innerHTML = marked.parse(sourceWithCaret);

      // MathJaxの準備完了待ち（初回読み込み中の事故防止）
      if (!window.MathJax || !MathJax.typesetPromise) return;

      // 右ペインだけ再レンダリング
      await MathJax.typesetPromise([out]);
      syncScrollFromSource();
    }

    function scheduleRender() {
      clearTimeout(timer);
      timer = setTimeout(render, 120);
    }

    // 入力のたびに即レンダリングすると重いので軽くデバウンス
    src.addEventListener('input', scheduleRender);
    src.addEventListener('scroll', syncScrollFromSource);
    src.addEventListener('click', scheduleRender);
    src.addEventListener('keyup', scheduleRender);
    src.addEventListener('select', scheduleRender);

    // 初回描画
    window.addEventListener('load', render);

    function setPaneWidths(clientX) {
      const wrapRect = resizer.parentElement.getBoundingClientRect();
      const minPaneWidth = 160;
      const maxLeft = wrapRect.width - minPaneWidth - resizer.offsetWidth;
      const nextLeft = Math.min(Math.max(clientX - wrapRect.left, minPaneWidth), maxLeft);
      const rightWidth = wrapRect.width - nextLeft - resizer.offsetWidth;
      leftPane.style.flex = `0 0 ${nextLeft}px`;
      rightPane.style.flex = `0 0 ${rightWidth}px`;
    }

    resizer.addEventListener('pointerdown', (event) => {
      dragging = true;
      resizer.classList.add('dragging');
      resizer.setPointerCapture(event.pointerId);
      setPaneWidths(event.clientX);
    });

    resizer.addEventListener('pointermove', (event) => {
      if (!dragging) return;
      setPaneWidths(event.clientX);
    });

    resizer.addEventListener('pointerup', (event) => {
      dragging = false;
      resizer.classList.remove('dragging');
      resizer.releasePointerCapture(event.pointerId);
    });

    resizer.addEventListener('pointercancel', () => {
      dragging = false;
      resizer.classList.remove('dragging');
    });
  </script>
</body>
</html>









