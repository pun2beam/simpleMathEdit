<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="./favicon.ico" sizes="any">
  <link rel="stylesheet" href="./style.css" />
  <title>MathJax Live Preview</title>

  <!-- MathJax v3 -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
      },
    };
  </script>
  <script defer src="./es5/tex-mml-chtml.js"></script>
  <script src="./marked/marked.min.js"></script>

</head>
<body>
  <div class="wrap">
    <div class="pane" id="left-pane">
      <div class="editor-header">
        <label class="file-label" for="file-name">ファイル名:</label>
        <input id="file-name" type="text" placeholder="ファイル名" value="notes" />
        <button id="save-button" type="button">Save</button>
        <button id="load-button" type="button">Load</button>
        <input id="file-input" type="file" accept=".md,text/markdown,text/plain" hidden />
      </div>
      <textarea id="src">
インライン: $E=mc^2$

別行表示:
$$
\frac{\mathrm{d}y}{\mathrm{d}x}=g(y)h(x)
$$
      </textarea>
    </div>

    <div class="resizer" id="resizer" role="separator" aria-label="Resize panes" aria-orientation="vertical"></div>

    <div class="pane preview" id="right-pane">
      <div id="out"></div>
    </div>
  </div>

  <script>
    const src = document.getElementById('src');
    const out = document.getElementById('out');
    const resizer = document.getElementById('resizer');
    const leftPane = document.getElementById('left-pane');
    const rightPane = document.getElementById('right-pane');
    const fileNameInput = document.getElementById('file-name');
    const saveButton = document.getElementById('save-button');
    const loadButton = document.getElementById('load-button');
    const fileInput = document.getElementById('file-input');
    let timer = null;
    let dragging = false;

    marked.setOptions({ mangle: false, headerIds: false });

    const caretToken = '│';
    const caretHtml = '<span id="caret-marker" aria-hidden="true" data-mjx-skip="true">▌</span>';

    function buildSourceWithCaret() {
      const caretIndex = src.selectionStart ?? 0;
      return `${src.value.slice(0, caretIndex)}${caretToken}${src.value.slice(caretIndex)}`;
    }

    function syncScrollFromSource() {
      const outMax = out.scrollHeight - rightPane.clientHeight;
      if (outMax <= 0) {
        rightPane.scrollTop = 0;
        return;
      }
      const caretIndex = src.selectionStart ?? 0;
      const beforeCaret = src.value.slice(0, caretIndex);
      const caretLine = beforeCaret.split('\n').length;
      const totalLines = Math.max(src.value.split('\n').length, 1);
      const ratio = Math.min(Math.max((caretLine - 1) / Math.max(totalLines - 1, 1), 0), 1);
      const targetScrollTop = ratio * outMax;
      rightPane.scrollTop = targetScrollTop;
    }

    function normalizeDisplayMath(source) {
      const lines = source.split('\n');
      const normalized = [];
      let inDisplay = false;

      for (let line of lines) {
        if (line.trim() === '$$') {
          inDisplay = !inDisplay;
          normalized.push('$$');
          continue;
        }

        if (inDisplay && line.trim() === '') {
          continue;
        }

        if (inDisplay) {
          line = line.replace(/\\/g, '\\\\');
        }

        normalized.push(line);
      }

      return normalized.join('\n');
    }

    function formatDateTime(date) {
      const pad = (value) => String(value).padStart(2, '0');
      return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}${pad(date.getHours())}${pad(date.getMinutes())}`;
    }

    function getBaseFileName() {
      const rawName = fileNameInput.value.trim();
      return rawName === '' ? 'notes' : rawName.replace(/\.md$/i, '');
    }

    function buildDownloadFileName(baseName) {
      const timestamp = formatDateTime(new Date());
      return `${baseName}_${timestamp}.md`;
    }

    function normalizeLoadedFileName(fileName) {
      const match = fileName.match(/^(.*)_([0-9]+)\.md$/i);
      if (match && /^[0-9]+$/.test(match[2])) {
        return match[1];
      }
      if (/\.md$/i.test(fileName)) {
        return fileName.replace(/\.md$/i, '');
      }
      return fileName;
    }

    async function render() {
      const sourceWithCaret = normalizeDisplayMath(buildSourceWithCaret());
      // const html = marked.parse(sourceWithCaret);
      // out.innerHTML = html.replace(caretToken, caretHtml);
      out.innerHTML = marked.parse(sourceWithCaret);

      // MathJaxの準備完了待ち（初回読み込み中の事故防止）
      if (!window.MathJax || !MathJax.typesetPromise) return;

      // 右ペインだけ再レンダリング
      await MathJax.typesetPromise([out]);
      syncScrollFromSource();
    }

    function scheduleRender() {
      clearTimeout(timer);
      timer = setTimeout(render, 120);
    }

    // 入力のたびに即レンダリングすると重いので軽くデバウンス
    src.addEventListener('input', scheduleRender);
    src.addEventListener('scroll', syncScrollFromSource);
    src.addEventListener('click', scheduleRender);
    src.addEventListener('keyup', scheduleRender);
    src.addEventListener('select', scheduleRender);

    saveButton.addEventListener('click', () => {
      const baseName = getBaseFileName();
      const downloadName = buildDownloadFileName(baseName);
      const blob = new Blob([src.value], { type: 'text/markdown;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = downloadName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    loadButton.addEventListener('click', () => {
      fileInput.value = '';
      fileInput.click();
    });

    fileInput.addEventListener('change', (event) => {
      const [file] = event.target.files;
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        src.value = reader.result ?? '';
        const normalizedName = normalizeLoadedFileName(file.name);
        fileNameInput.value = normalizedName;
        scheduleRender();
      };
      reader.readAsText(file);
    });

    // 初回描画
    window.addEventListener('load', render);

    function setPaneWidths(clientX) {
      const wrapRect = resizer.parentElement.getBoundingClientRect();
      const minPaneWidth = 160;
      const maxLeft = wrapRect.width - minPaneWidth - resizer.offsetWidth;
      const nextLeft = Math.min(Math.max(clientX - wrapRect.left, minPaneWidth), maxLeft);
      const rightWidth = wrapRect.width - nextLeft - resizer.offsetWidth;
      leftPane.style.flex = `0 0 ${nextLeft}px`;
      rightPane.style.flex = `0 0 ${rightWidth}px`;
    }

    resizer.addEventListener('pointerdown', (event) => {
      dragging = true;
      resizer.classList.add('dragging');
      resizer.setPointerCapture(event.pointerId);
      setPaneWidths(event.clientX);
    });

    resizer.addEventListener('pointermove', (event) => {
      if (!dragging) return;
      setPaneWidths(event.clientX);
    });

    resizer.addEventListener('pointerup', (event) => {
      dragging = false;
      resizer.classList.remove('dragging');
      resizer.releasePointerCapture(event.pointerId);
    });

    resizer.addEventListener('pointercancel', () => {
      dragging = false;
      resizer.classList.remove('dragging');
    });
  </script>
</body>
</html>









